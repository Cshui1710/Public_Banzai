<!-- templates/quiz_maker_admin.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ä½œå•ç·¨é›†ï¼ˆç®¡ç†è€…ï¼‰ | Ishikawa Facilities & Parks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    :root {
      --indigo: #4f46e5;
      --indigo-soft: #eef2ff;
      --danger-soft: #fef2f2;
      --slate: #0f172a;
    }

    body {
      background: radial-gradient(circle at top, #e0f2fe 0, #f5f3ff 30%, #f9fafb 70%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #0f172a;
    }

    .navbar {
      background: rgba(255,255,255,0.96) !important;
      border-bottom: 1px solid rgba(148,163,184,0.35);
      backdrop-filter: blur(10px);
    }

    .card {
      border: 0;
      border-radius: 1rem;
      box-shadow: 0 12px 30px rgba(15,23,42,0.08);
      background: #ffffff;
    }

    .badge-role {
      font-size: .7rem;
      letter-spacing: .12em;
      text-transform: uppercase;
      border-radius: 999px;
      padding: .25rem .7rem;
      background: var(--indigo-soft);
      color: #4338ca;
    }

    .page-header-card {
      border-radius: 1.1rem;
      background: linear-gradient(135deg, #eef2ff, #e0f2fe 55%, #fef3c7 100%);
      border: 1px solid rgba(129,140,248,0.4);
    }

    .page-header-title {
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: .4rem;
    }

    .page-header-title span.icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #4f46e5;
      color: #fff;
      font-size: 1.1rem;
      box-shadow: 0 10px 20px rgba(79,70,229,0.35);
    }

    .page-header-sub {
      font-size: .85rem;
      color: #4b5563;
    }

    .page-header-meta {
      font-size: .75rem;
      color: #6b7280;
      text-align: right;
    }

    .table-wrap {
      max-height: 520px;
      overflow: auto;
      border-radius: .75rem;
      border: 1px solid rgba(148,163,184,0.35);
    }

    .table thead th {
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #6b7280;
      background: #f9fafb;
      border-top: none;
    }

    .table tbody tr:hover {
      background: #f9fafb;
    }

    .q-stem {
      font-weight: 600;
      font-size: .9rem;
      color: #0f172a;
    }

    .q-meta {
      font-size: .78rem;
      color: #64748b;
    }

    .pill {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 1.4rem;
      gap:.25rem;
      border-radius:999px;
      padding:.05rem .5rem;
      font-size:.7rem;
      background: var(--indigo-soft);
      color: #4f46e5;
      margin-right: .25rem;
    }

    .hint-pill {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .15rem .6rem;
      border-radius: 999px;
      background: #fef9c3;
      color: #854d0e;
      font-size: .75rem;
      margin-top: .25rem;
    }

    .hint-pill span.icon {
      font-size: .9rem;
    }

    .filter-label {
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: #6b7280;
    }

    .filter-card {
      border-radius: 1rem;
    }

    .btn-outline-primary.btn-sm {
      border-radius: 999px;
      font-size: .78rem;
      padding-inline: 1rem;
    }

    .btn-delete-soft {
      border-radius: 999px;
      font-size: .75rem;
      padding: .2rem .75rem;
      border-color: #fecaca;
      color: #b91c1c;
      background: var(--danger-soft);
    }
    .btn-delete-soft:hover {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #991b1b;
    }

    /* small helper */
    .text-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>
<body>
  <!-- ãƒŠãƒ“ -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/home">
        Ishikawa Facilities &amp; Parks
      </a>
      <div class="ms-auto d-flex align-items-center gap-3">
        <span class="text-muted small">
          ç®¡ç†è€…: {{ user.display_name or user.email }}
        </span>
        <a href="/home" class="btn btn-outline-secondary btn-sm">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>
      </div>
    </div>
  </nav>
    <!-- BGM -->
    <audio id="bgmAudio" loop>
    <source src="/static/bgm/home_bgm2.mp3" type="audio/mpeg">
    </audio>
    <div style="position: fixed; right: 1rem; bottom: 1rem; z-index: 2000;">
    <button id="bgmToggleBtn" class="btn btn-sm btn-dark">
        ğŸµ BGM ON
    </button>
    </div>
  
  <main class="container py-4">
    <!-- ãƒ˜ãƒƒãƒ€ã‚«ãƒ¼ãƒ‰ -->
    <div class="card page-header-card mb-3">
      <div class="card-body d-flex flex-wrap justify-content-between align-items-start gap-3">
        <div>
          <div class="page-header-title mb-1">
            <span class="icon">âš™ï¸</span>
            <span>ä½œå•ç·¨é›†ï¼ˆç®¡ç†è€…ç”¨ï¼‰</span>
          </div>
          <p class="page-header-sub mb-0">
            ã¿ã‚“ãªãŒä½œã£ãŸã‚¯ã‚¤ã‚ºå•é¡Œã‚’ä¸€è¦§è¡¨ç¤ºã—ã€ä¸é©åˆ‡ãªå•é¡Œã‚’å‰Šé™¤ã§ãã¾ã™ã€‚  
            æˆæ¥­ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã®ç›®çš„ã«åˆã‚ã›ã¦ã€å•é¡Œãƒ—ãƒ¼ãƒ«ã‚’ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã§ãã¾ã™ã€‚
          </p>
        </div>
        <div class="text-end">
          <div class="badge-role mb-1">Q MAKER ADMIN</div>
          <div id="summaryText" class="page-header-meta">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="card filter-card mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-5">
            <label class="filter-label form-label mb-1">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
            <input
              id="searchInput"
              type="text"
              class="form-control form-control-sm"
              placeholder="å•é¡Œæ–‡ / ãƒ’ãƒ³ãƒˆ / ä½œæˆè€… ã§æ¤œç´¢ï¼ˆä¾‹ï¼šå›³æ›¸é¤¨ / é‡‘æ²¢å¸‚ ãªã©ï¼‰"
            >
          </div>
          <div class="col-md-3">
            <label class="filter-label form-label mb-1">ä¸¦ã³é †</label>
            <select id="sortSelect" class="form-select form-select-sm">
              <option value="newest">æ–°ã—ã„é †</option>
              <option value="oldest">å¤ã„é †</option>
              <option value="author">ä½œæˆè€…åé †</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="filter-label form-label mb-1">è¡¨ç¤ºä»¶æ•°</label>
            <select id="limitSelect" class="form-select form-select-sm">
              <option value="50">50ä»¶ã¾ã§</option>
              <option value="100">100ä»¶ã¾ã§</option>
              <option value="0">ã™ã¹ã¦è¡¨ç¤º</option>
            </select>
          </div>
          <div class="col-md-2 d-grid">
            <button id="reloadBtn" class="btn btn-outline-primary btn-sm">
              ğŸ”„ å†èª­ã¿è¾¼ã¿
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸€è¦§ -->
    <div class="card">
      <div class="card-body">
        <div class="table-wrap mt-1 bg-white">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:4rem;">ID</th>
                <th>å•é¡Œ / ãƒ’ãƒ³ãƒˆ / é¸æŠè‚¢</th>
                <th style="width:10rem;">ä½œæˆè€…</th>
                <th style="width:9rem;">ä½œæˆæ—¥æ™‚</th>
                <th style="width:6rem;" class="text-end">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="qTableBody">
              <tr>
                <td colspan="5" class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    var ALL_QUESTIONS = [];

    function escapeHtml(s) {
      return String(s == null ? "" : s).replace(/[&<>"']/g, function(m) {
        return {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;"
        }[m];
      });
    }

    async function fetchQuestions() {
      var r = await fetch("/api/quiz/maker/admin/list");
      if (!r.ok) {
        throw new Error("HTTP " + r.status);
      }
      var js = await r.json();
      if (!js.ok) {
        throw new Error(js.error || "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
      return js.questions || [];
    }

    function applyFilterAndRender() {
      var searchEl = document.getElementById("searchInput");
      var sortEl   = document.getElementById("sortSelect");
      var limitEl  = document.getElementById("limitSelect");

      var search = (searchEl.value || "").trim().toLowerCase();
      var sort   = sortEl.value;
      var limit  = parseInt(limitEl.value || "0", 10);

      var items = ALL_QUESTIONS.slice();

      if (search) {
        items = items.filter(function(q) {
          var hay = (q.stem || "") + " " + (q.hint || "") + " " + (q.user_name || "");
          return hay.toLowerCase().indexOf(search) !== -1;
        });
      }

      if (sort === "newest") {
        items.sort(function(a, b) {
          return String(b.created_at || "").localeCompare(String(a.created_at || ""));
        });
      } else if (sort === "oldest") {
        items.sort(function(a, b) {
          return String(a.created_at || "").localeCompare(String(b.created_at || ""));
        });
      } else if (sort === "author") {
        items.sort(function(a, b) {
          return String(a.user_name || "").localeCompare(String(b.user_name || ""));
        });
      }

      if (limit > 0) {
        items = items.slice(0, limit);
      }

      renderTable(items);
    }

    function renderTable(items) {
      var tbody   = document.getElementById("qTableBody");
      var summary = document.getElementById("summaryText");

      summary.textContent = "å…¨ " + ALL_QUESTIONS.length + " ä»¶ä¸­ã€è¡¨ç¤º " + items.length + " ä»¶";

      if (!items.length) {
        tbody.innerHTML = "<tr><td colspan=\"5\" class=\"text-muted small\">è©²å½“ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>";
        return;
      }

      tbody.innerHTML = "";

      items.forEach(function(q) {
        var tr = document.createElement("tr");

        var choicesHtml = "";
        (q.choices || []).forEach(function(c, i) {
          choicesHtml +=
            "<span class=\"pill\">" + (i + 1) + "</span>" +
            "<span>" + escapeHtml(c) + "</span><br>";
        });

        var hintHtml = "";
        if (q.hint) {
          hintHtml =
            "<div class=\"hint-pill mt-1\">" +
              "<span class=\"icon\">ğŸ’¡</span>" +
              "<span>" + escapeHtml(q.hint) + "</span>" +
            "</div>";
        }

        var created = escapeHtml(q.created_at || "");

        tr.innerHTML =
          "<td><span class=\"small text-mono text-muted\">#" + q.id + "</span></td>" +
          "<td>" +
            "<div class=\"q-stem\">" + escapeHtml(q.stem) + "</div>" +
            hintHtml +
            "<div class=\"q-meta mt-2\">" + choicesHtml + "</div>" +
          "</td>" +
          "<td>" +
            "<div class=\"small fw-semibold\">" + escapeHtml(q.user_name || "") + "</div>" +
            "<div class=\"q-meta text-mono\">user_id: " + q.user_id + "</div>" +
          "</td>" +
          "<td><span class=\"q-meta\">" + created + "</span></td>" +
          "<td class=\"text-end\">" +
            "<button class=\"btn btn-delete-soft btn-sm btn-delete\" data-id=\"" + q.id + "\">å‰Šé™¤</button>" +
          "</td>";

        tbody.appendChild(tr);
      });

      // å‰Šé™¤ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸
      var btns = tbody.querySelectorAll(".btn-delete");
      Array.prototype.forEach.call(btns, function(btn) {
        btn.addEventListener("click", function() {
          var id = parseInt(btn.getAttribute("data-id"), 10);
          onDeleteQuestion(id);
        });
      });
    }

    async function onDeleteQuestion(id) {
      if (!confirm("å•é¡Œ #" + id + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰")) {
        return;
      }
      try {
        var r = await fetch("/api/quiz/maker/admin/" + id, {
          method: "DELETE"
        });
        var js = await r.json();
        if (!r.ok || !js.ok) {
          alert(js.error || "å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
          return;
        }
        ALL_QUESTIONS = ALL_QUESTIONS.filter(function(q) { return q.id !== id; });
        applyFilterAndRender();
      } catch (e) {
        console.error(e);
        alert("å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    }

    async function reloadAll() {
      try {
        document.getElementById("summaryText").textContent = "èª­ã¿è¾¼ã¿ä¸­...";
        ALL_QUESTIONS = await fetchQuestions();
        applyFilterAndRender();
      } catch (e) {
        console.error(e);
        document.getElementById("summaryText").textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
        var tbody = document.getElementById("qTableBody");
        tbody.innerHTML =
          "<tr><td colspan=\"5\" class=\"text-muted small\">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td></tr>";
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      var searchInput = document.getElementById("searchInput");
      var sortSelect  = document.getElementById("sortSelect");
      var limitSelect = document.getElementById("limitSelect");
      var reloadBtn   = document.getElementById("reloadBtn");

      if (searchInput) {
        searchInput.addEventListener("input", applyFilterAndRender);
      }
      if (sortSelect) {
        sortSelect.addEventListener("change", applyFilterAndRender);
      }
      if (limitSelect) {
        limitSelect.addEventListener("change", applyFilterAndRender);
      }
      if (reloadBtn) {
        reloadBtn.addEventListener("click", reloadAll);
      }

      reloadAll();
    });
  </script>

    <script>
    (function () {
        const audio = document.getElementById("bgmAudio");
        const btn   = document.getElementById("bgmToggleBtn");
        if (!audio || !btn) return;

        /* â–¼ éŸ³é‡ã‚’50%ã«è¨­å®š â–¼ */
        audio.volume = 0.5;

        const STORAGE_KEY = "ifp_bgm_enabled";

        let enabled = localStorage.getItem(STORAGE_KEY);
        enabled = (enabled === null) ? true : (enabled === "true");

        const updateButtonText = () => {
        btn.textContent = enabled ? "ğŸµ BGM ON" : "ğŸ”‡ BGM OFF";
        };

        const playIfAllowed = async () => {
        if (!enabled) {
            try { audio.pause(); } catch(e) {}
            return;
        }
        try {
            await audio.play();
        } catch (e) {
            console.log("BGM autoplay blocked:", e);
        }
        };

        updateButtonText();

        // åˆå›ã‚¯ãƒªãƒƒã‚¯ã§å†ç”Ÿé–‹å§‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™å¯¾ç­–ï¼‰
        const onFirstInteract = () => {
        document.removeEventListener("click", onFirstInteract);
        playIfAllowed();
        };
        document.addEventListener("click", onFirstInteract);

        btn.addEventListener("click", async () => {
        enabled = !enabled;
        localStorage.setItem(STORAGE_KEY, String(enabled));
        updateButtonText();
        if (enabled) {
            await playIfAllowed();
        } else {
            audio.pause();
        }
        });
    })();
    </script>
  
</body>
</html>
