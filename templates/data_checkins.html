<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ‡ãƒ¼ã‚¿æä¾›ãã®2 | æ™‚é–“ãƒ»æœŸé–“åˆ¥ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.jsï¼ˆç°¡æ˜“ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #f3f4ff;
      --panel-bg: #ffffff;
      --accent: #6366f1;
      --card-radius: 1rem;
      --shadow-soft: 0 14px 30px rgba(15,23,42,0.12);
      --border-subtle: rgba(148,163,184,0.4);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #e0f2fe 0, #f5f3ff 30%, #f9fafb 70%);
      color: #0f172a;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ãƒ–ãƒ©ãƒ³ãƒ‰ç³»ï¼ˆhome.html ã¨å…±é€šãƒ†ã‚¤ã‚¹ãƒˆï¼‰ */
    .brand-mark {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      font-weight: 800;
      letter-spacing: .02em;
      text-decoration: none;
      color: #0f172a;
    }
    .brand-logo {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: conic-gradient(from 160deg, #22c55e, #0ea5e9, #6366f1, #22c55e);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .85rem;
      color: #fff;
      box-shadow: 0 0 0 2px #e5e7eb;
    }

    .nav-glass {
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.96);
      border-bottom: 1px solid var(--border-subtle);
      box-shadow: 0 10px 30px rgba(15,23,42,0.06);
      padding: .55rem 1rem;
    }

    .nav-inner {
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      flex-wrap: wrap;
    }

    .pill-beta {
      border-radius: 999px;
      padding: .25rem .75rem;
      font-size: .75rem;
      background: #eef2ff;
      color: #4338ca;
      border: 1px solid rgba(129,140,248,0.5);
      display: inline-flex;
      align-items: center;
      gap: .35rem;
    }

    .btn-soft {
      border-radius: 999px;
      font-size: .8rem;
      padding-inline: 1rem;
    }

    main.page-root {
      flex: 1;
      padding: 1.8rem 1.2rem 2.6rem;
    }

    .container-narrow {
      max-width: 1100px;
    }

    .section-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: .75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .section-label {
      font-size: .78rem;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: #6b7280;
      font-weight: 700;
    }
    .section-title {
      font-size: 1.2rem;
      font-weight: 800;
      margin: 0;
    }
    .section-sub {
      font-size: .86rem;
      color: #6b7280;
      margin: 0.1rem 0 0;
    }

    .card {
      border-radius: var(--card-radius);
      border: 0;
      box-shadow: var(--shadow-soft);
      background: rgba(255,255,255,0.98);
    }

    pre.csv-preview {
      background:#0f172a;
      color:#e5e7eb;
      padding:8px 12px;
      border-radius:8px;
      font-size:12px;
      max-height:220px;
      overflow:auto;
      white-space:pre;
    }

    .badge-pill {
      border-radius:999px;
      padding:.25rem .7rem;
      font-size:.8rem;
    }

    @media (max-width: 576px) {
      main.page-root {
        padding-top: 1.4rem;
      }
    }
  </style>
</head>
<body>

  <!-- ãƒŠãƒ“ãƒãƒ¼ -->
  <header class="nav-glass">
    <div class="nav-inner">
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <a href="/home" class="brand-mark">
          <span class="brand-logo">IF</span>
          <span>Ishikawa Facilities &amp; Parks</span>
        </a>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <a href="/home" class="btn btn-outline-secondary btn-sm btn-soft">
            â† ãƒ›ãƒ¼ãƒ 
          </a>
          <span class="pill-beta">
            ğŸ“Š ãƒ‡ãƒ¼ã‚¿æä¾›ãã®2ï¼šæ™‚é–“ãƒ»æœŸé–“åˆ¥ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³
          </span>
        </div>
      </div>
      <span class="pill-beta">
        Î²ç‰ˆãƒ»ç ”ç©¶ç›®çš„ã§ã®åˆ©ç”¨ã‚’æƒ³å®š
      </span>
    </div>
  </header>

  <main class="page-root">
    <div class="container container-narrow">

      <!-- ä¸Šéƒ¨ã‚¿ã‚¤ãƒˆãƒ« & èª¬æ˜ -->
      <div class="section-head">
        <div>
          <div class="section-label">ANALYTICS LINE</div>
          <h1 class="section-title">æ™‚é–“ãƒ»æœŸé–“åˆ¥ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
          <p class="section-sub">
            ã‚¢ãƒ—ãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å±¥æ­´ã‹ã‚‰ã€æ–½è¨­åˆ¥ã®åˆ©ç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚
            æ¡ä»¶ã‚’å¤‰ãˆãªãŒã‚‰ã€ã©ã®å¸‚ç”ºãƒ»æ–½è¨­ãŒã„ã¤ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹æ¢ã£ã¦ã¿ã¦ãã ã•ã„ã€‚
          </p>
        </div>
      </div>

      <!-- èª¬æ˜ã‚«ãƒ¼ãƒ‰ -->
      <div class="card mb-4">
        <div class="card-body">
          <h2 class="h6 mb-2">æ¦‚è¦</h2>
          <p class="mb-2 text-muted">
            ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€ã‚¢ãƒ—ãƒªåˆ©ç”¨è€…ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å±¥æ­´ã‚’ã‚‚ã¨ã«ã€
            <strong>æ–½è¨­ Ã— æ—¥ä»˜ Ã— æ™‚é–“å¸¯</strong>ã”ã¨ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å›æ•°ã‚’
            CSVå½¢å¼ã§æä¾›ã—ã¾ã™ã€‚ã‚ã‚ã›ã¦ç°¡å˜ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å‚¾å‘ã‚’ç¢ºèªã§ãã¾ã™ã€‚
          </p>
          <p class="mb-0 small text-muted">
            ä¾‹ï¼‰ã€Œ2025å¹´4æœˆã€œ6æœˆã€ã€Œå¤•æ–¹ã€ã€Œå…¬åœ’ã®ã¿ã€ãªã©ã‚’æ¡ä»¶ã«ã—ã¦ã€
            ã©ã®æ–½è¨­ãŒã‚ˆãåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã€æ™‚é–“å¸¯ã”ã¨ã®å‚¾å‘ã‚’æŠŠæ¡ã§ãã¾ã™ã€‚
          </p>
        </div>
      </div>

      <!-- æ¡ä»¶æŒ‡å®š + CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
      <div class="card mb-4">
        <div class="card-body">
          <h2 class="h6 mb-3">â‘  é›†è¨ˆæ¡ä»¶ã®æŒ‡å®š &amp; CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>

          <div class="row g-3 align-items-end">

            <div class="col-md-4">
              <label class="form-label">æœŸé–“ï¼ˆé–‹å§‹æ—¥ï¼‰</label>
              <input id="df" type="date" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">æœŸé–“ï¼ˆçµ‚äº†æ—¥ï¼‰</label>
              <input id="dt" type="date" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">ç¨®åˆ¥</label>
              <select id="kind" class="form-select">
                <option value="">ã™ã¹ã¦</option>
                <option value="å…¬åœ’">å…¬åœ’ã®ã¿</option>
                <option value="å…¬å…±æ–½è¨­">å…¬å…±æ–½è¨­ã®ã¿</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">æ™‚é–“å¸¯</label>
              <select id="tod" class="form-select">
                <option value="">æŒ‡å®šãªã—</option>
                <option value="morning">æœ (05â€“10)</option>
                <option value="noon">æ˜¼ (10â€“15)</option>
                <option value="evening">å¤•æ–¹ (15â€“19)</option>
                <option value="night">å¤œ (19â€“23)</option>
                <option value="late">æ·±å¤œ (23â€“05)</option>
              </select>
            </div>

            <div class="col-md-8">
              <label class="form-label">æ–½è¨­åãƒ»å¸‚ç”ºæ‘ã§çµã‚Šè¾¼ã¿ï¼ˆä»»æ„ï¼‰</label>
              <input id="q" type="text" class="form-control"
                     placeholder="ä¾‹ï¼šé‡‘æ²¢å¸‚ã€å…¼å…­åœ’ã€é‡ã€…å¸‚å¸‚å½¹æ‰€ ãªã©">
            </div>

          </div>

          <div class="d-flex flex-wrap gap-2 mt-3">
            <button class="btn btn-primary btn-soft" id="btnRefresh">ã“ã®æ¡ä»¶ã§é›†è¨ˆ</button>
            <a id="csvLink" class="btn btn-outline-secondary btn-soft" href="#" download>
              CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </a>
            <small class="text-muted ms-auto">
              å½¢å¼ï¼šUTF-8 / ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆãƒ˜ãƒƒãƒ€è¡Œã‚ã‚Šï¼‰
            </small>
          </div>
        </div>
      </div>

      <!-- CSV ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ & ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
      <div class="row g-4 mb-4">
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <h2 class="h6 mb-2">â‘¡ CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå…ˆé ­20è¡Œï¼‰</h2>
              <p class="small text-muted mb-2">
                ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
              </p>
              <pre id="csvPreview" class="csv-preview">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</pre>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <h2 class="h6 mb-2">â‘¢ ç°¡æ˜“ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
              <p class="small text-muted mb-2">
                åŒã˜æ¡ä»¶ã§é›†è¨ˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€æ—¥åˆ¥ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä»¶æ•°ã¨
                æ™‚é–“å¸¯ã”ã¨ã®å†…è¨³ã‚’ã‚°ãƒ©ãƒ•è¡¨ç¤ºã—ã¾ã™ã€‚
              </p>

              <div class="mb-3" style="height: 180px;">
                <canvas id="chartDaily"></canvas>
              </div>
              <div style="height: 180px;">
                <canvas id="chartTod"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CSVå½¢å¼ã®èª¬æ˜ -->
      <div class="card mb-4">
        <div class="card-body">
          <h2 class="h6 mb-3">æä¾›ã™ã‚‹CSVã®å½¢å¼</h2>
          <p class="small mb-2">
            1è¡ŒãŒã€Œæ–½è¨­ Ã— æ—¥ä»˜ Ã— æ™‚é–“å¸¯ã€ã®çµ„ã¿åˆã‚ã›ã‚’è¡¨ã—ã€ãã“ã«å±ã™ã‚‹
            ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä»¶æ•°ãŒ <code>checkins</code> ã‚«ãƒ©ãƒ ã«è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚
          </p>

          <pre class="csv-preview">
date, hour_band, tod, place_id, place_name, kind, municipality, lat, lon, checkins
2025-04-01, "05-10", morning, "170001-001", "å…¼å…­åœ’", "å…¬åœ’", "é‡‘æ²¢å¸‚", 36.5611, 136.6623, 12
2025-04-01, "10-15", noon,    "170001-001", "å…¼å…­åœ’", "å…¬åœ’", "é‡‘æ²¢å¸‚", 36.5611, 136.6623, 35
2025-04-01, "15-19", evening, "170045-010", "é‡ã€…å¸‚å¸‚å½¹æ‰€", "å…¬å…±æ–½è¨­", "é‡ã€…å¸‚å¸‚", 36.5290, 136.6098, 5
...
          </pre>

          <ul class="small text-muted mb-0">
            <li><code>date</code>ï¼šãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥ï¼ˆJSTï¼‰</li>
            <li><code>hour_band</code>ï¼šæ™‚é–“å¸¯ã®æ™‚åˆ»ç¯„å›²ï¼ˆæ–‡å­—åˆ—ï¼‰</li>
            <li><code>tod</code>ï¼šæ™‚é–“å¸¯ã‚«ãƒ†ã‚´ãƒªï¼ˆmorning / noon / evening / night / lateï¼‰</li>
            <li><code>place_id</code>ï¼šæ–½è¨­IDï¼ˆã‚¢ãƒ—ãƒªå†…éƒ¨ã§åˆ©ç”¨ã—ã¦ã„ã‚‹IDï¼‰</li>
            <li><code>place_name</code>ï¼šæ–½è¨­åç§°</li>
            <li><code>kind</code>ï¼šå…¬åœ’ / å…¬å…±æ–½è¨­ ãªã©</li>
            <li><code>municipality</code>ï¼šå¸‚ç”ºæ‘å</li>
            <li><code>lat, lon</code>ï¼šæ–½è¨­ã®åº§æ¨™ï¼ˆWGS84ï¼‰</li>
            <li><code>checkins</code>ï¼šãã®æ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä»¶æ•°</li>
          </ul>
        </div>
      </div>

    </div>
  </main>

  <script>
    const csvBaseUrl = '/api/export/checkins_summary.csv';  // CSV APIï¼ˆã‚µãƒ¼ãƒå´ã§å®Ÿè£…ï¼‰
    let chartDaily = null;
    let chartTod   = null;

    function buildQuery() {
      const df  = document.getElementById('df').value;
      const dt  = document.getElementById('dt').value;
      const kind= document.getElementById('kind').value;
      const tod = document.getElementById('tod').value;
      const q   = document.getElementById('q').value.trim();

      const params = new URLSearchParams();
      if (df)   params.set('date_from', df);
      if (dt)   params.set('date_to',   dt);
      if (kind) params.set('kind', kind);
      if (tod)  params.set('tod', tod);
      if (q)    params.set('q', q);
      return params;
    }

    function setCsvLink() {
      const params = buildQuery();
      const href = csvBaseUrl + (params.toString() ? ('?' + params.toString()) : '');
      document.getElementById('csvLink').href = href;
    }

    // ã”ãç°¡å˜ãª CSV ãƒ‘ãƒ¼ã‚µï¼ˆã‚«ãƒ³ãƒã¨æ”¹è¡Œã®ã¿å¯¾å¿œã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒˆã¯æœ€å°é™ï¼‰
    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return { header: [], rows: [] };
      const header = lines[0].split(',');
      const rows = lines.slice(1).map(line => {
        // "..." ã‚’ç°¡æ˜“é™¤å»ï¼ˆæœ¬æ ¼çš„ã«ã‚„ã‚‹ãªã‚‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
        const cols = [];
        let cur = '', inQ = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"' ) {
            inQ = !inQ;
          } else if (ch === ',' && !inQ) {
            cols.push(cur); cur = '';
          } else {
            cur += ch;
          }
        }
        cols.push(cur);
        return cols;
      });
      return { header, rows };
    }

    function updatePreview(text) {
      const lines = text.trim().split(/\r?\n/).slice(0, 21); // ãƒ˜ãƒƒãƒ€ + 20è¡Œ
      document.getElementById('csvPreview').textContent = lines.join('\n');
    }

    function updateCharts(text) {
      const { header, rows } = parseCsv(text);
      if (!header.length) return;

      const idxDate  = header.indexOf('date');
      const idxTod   = header.indexOf('tod');
      const idxCnt   = header.indexOf('checkins');
      if (idxDate < 0 || idxTod < 0 || idxCnt < 0) return;

      const dailyMap = new Map();  // date -> sum
      const todMap   = new Map();  // tod -> sum

      for (const cols of rows) {
        const d   = cols[idxDate];
        const tod = cols[idxTod] || '(ä¸æ˜)';
        const c   = Number(cols[idxCnt] || 0);
        dailyMap.set(d,   (dailyMap.get(d)   || 0) + c);
        todMap.set(tod,   (todMap.get(tod)   || 0) + c);
      }

      const dailyLabels = Array.from(dailyMap.keys()).sort();
      const dailyValues = dailyLabels.map(d => dailyMap.get(d));

      const todLabels   = Array.from(todMap.keys());
      const todValues   = todLabels.map(k => todMap.get(k));

      const ctxDaily = document.getElementById('chartDaily').getContext('2d');
      const ctxTod   = document.getElementById('chartTod').getContext('2d');

      if (chartDaily) chartDaily.destroy();
      if (chartTod)   chartTod.destroy();

      chartDaily = new Chart(ctxDaily, {
        type: 'line',
        data: {
          labels: dailyLabels,
          datasets: [{
            label: 'æ—¥åˆ¥ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä»¶æ•°',
            data: dailyValues
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          scales: { x: { ticks: { maxTicksLimit: 8 } } }
        }
      });

      chartTod = new Chart(ctxTod, {
        type: 'bar',
        data: {
          labels: todLabels,
          datasets: [{
            label: 'æ™‚é–“å¸¯åˆ¥ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä»¶æ•°',
            data: todValues
          }]
        }
      ...
      });
    }

    async function refreshAll() {
      setCsvLink();
      const params = buildQuery();
      const url = csvBaseUrl + (params.toString() ? ('?' + params.toString()) : '');
      try {
        const res = await fetch(url);
        if (!res.ok) {
          document.getElementById('csvPreview').textContent = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
          return;
        }
        const text = await res.text();
        if (!text.trim()) {
          document.getElementById('csvPreview').textContent = 'æ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
          return;
        }
        updatePreview(text);
        updateCharts(text);
      } catch (e) {
        console.error(e);
        document.getElementById('csvPreview').textContent = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
      }
    }

    // åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', () => {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé–“ï¼šç›´è¿‘30æ—¥
      const today = new Date();
      const from  = new Date(today.getTime() - 29*24*60*60*1000);
      const pad = n => String(n).padStart(2, '0');
      const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      document.getElementById('df').value = fmt(from);
      document.getElementById('dt').value = fmt(today);

      setCsvLink();
      document.getElementById('btnRefresh').addEventListener('click', refreshAll);

      // åˆå›èª­ã¿è¾¼ã¿
      refreshAll();
    });
  </script>

</body>
</html>
