<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>ã‚¯ã‚¤ã‚º | Ishikawa Facilities & Parks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* Quiz specific styles */
    .choice-btn {
      width: 100%;
      text-align: left;
      margin-bottom: 12px;
      justify-content: flex-start;
    }

    .choice-correct {
      border: 2px solid #22c55e !important;
      background: rgba(34, 197, 94, 0.1);
    }

    .choice-wrong {
      opacity: 0.6;
      border: 1px solid #ef4444 !important;
    }

    .score-row {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }

    .member-pill {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 999px;
      font-size: 0.85rem;
      margin: 4px;
      border: 1px solid var(--card-border);
    }

    /* Hint Box */
    #qHintBox {
      border-radius: var(--radius-sm);
      border: 1px solid rgba(59, 130, 246, 0.3);
      background: rgba(59, 130, 246, 0.1);
      padding: 16px;
      display: none;
      margin-bottom: 20px;
    }

    #qHintLabel {
      font-size: 0.9rem;
      font-weight: 700;
      color: #60a5fa;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    #qHintText {
      font-size: 1rem;
      color: var(--text-main);
    }

    /* Stamp Grid */
    .stamp-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .stamp-btn {
      border: 1px solid var(--card-border);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .stamp-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .stamp-btn img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Stamp FX */
    .stamp-fx {
      position: fixed;
      z-index: 3000;
      pointer-events: none;
      width: 160px;
      animation: pop-float 850ms ease-out forwards;
    }

    @keyframes pop-float {
      0% {
        opacity: 0;
        transform: translateY(8px) scale(0.9);
      }

      20% {
        opacity: 1;
        transform: translateY(0) scale(1.0);
      }

      100% {
        opacity: 0;
        transform: translateY(-10px) scale(1.0);
      }
    }

    /* Stamp FAB */
    .stamp-fab {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 2500;
      width: 280px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-md);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: none;
    }

    .stamp-fab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      border-bottom: 1px solid var(--card-border);
    }

    .stamp-fab-body {
      max-height: 50vh;
      overflow: auto;
      padding: 12px;
    }

    /* O/X Overlay */
    .feedback-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      pointer-events: none;
      opacity: 0;
    }

    .feedback-mark {
      font-size: 15rem;
      font-weight: 900;
      text-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
      transform: scale(0.5);
    }

    .feedback-correct {
      color: #22c55e;
      animation: feedback-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .feedback-wrong {
      color: #ef4444;
      animation: feedback-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes feedback-pop {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }

      50% {
        opacity: 1;
        transform: scale(1.2);
      }

      100% {
        opacity: 0;
        transform: scale(1.0);
      }
    }

    .blinker {
      animation: blink 1s linear infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0.3;
      }
    }
  </style>
</head>

<body>
  <header class="navbar">
    <div class="container flex justify-between w-full">
      <div class="nav-brand">
        <div class="nav-brand-icon">ğŸ®</div>
        <div class="nav-brand-text">
          <div class="nav-brand-title">Ishikawa Facilities & Parks</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a class="btn btn-sm btn-secondary" href="/home">ãƒ›ãƒ¼ãƒ ã¸</a>
      </div>
    </div>
  </header>

  <main class="container py-8">
    {% if mode == "random-wait" %}
    <div class="card" style="max-width: 600px; margin: 0 auto; text-align: center;">
      <h1 class="text-2xl font-bold mb-4">ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒå¾…æ©Ÿä¸­ <span class="blinker">â—</span></h1>
      <p class="text-muted mb-8">äººæ•°ãŒæƒã„æ¬¡ç¬¬ã€è‡ªå‹•ã§å¯¾æˆ¦éƒ¨å±‹ã«ç§»å‹•ã—ã¾ã™ã€‚</p>
      <div class="flex justify-center">
        <button id="cancelBtn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
    <script>window.__PAGE_MODE__ = "random-wait";</script>

    {% elif mode == "room-created" %}
    <div class="card" style="max-width: 600px; margin: 0 auto; text-align: center;">
      <h1 class="text-2xl font-bold mb-4">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒãƒƒãƒã®éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸ</h1>
      <p class="text-muted mb-2">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å‹ã ã¡ã«å…±æœ‰ã—ã¦ãã ã•ã„ï¼š</p>
      <div class="flex items-center gap-2 justify-center mb-8">
        <input id="roomCode" class="text-3xl font-bold text-center" value="{{ code }}" readonly
          style="background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); color: white; padding: 12px; border-radius: 12px; width: 200px;">
        <button id="copyBtn" class="btn btn-primary">ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div class="flex justify-center">
        <a class="btn btn-primary" href="/quiz?code={{ code }}">éƒ¨å±‹ã«å…¥ã‚‹</a>
      </div>
    </div>
    <script>window.__PAGE_MODE__ = "room-created"; window.__ROOM_CODE__ = "{{ code }}";</script>

    {% elif mode == "room-join" %}
    <div class="card" style="max-width: 600px; margin: 0 auto; text-align: center;">
      <h1 class="text-2xl font-bold mb-4">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒãƒƒãƒã«å‚åŠ </h1>
      <div class="flex items-center gap-2 justify-center mb-4">
        <input id="joinCode" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
          style="background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); color: white; padding: 12px; border-radius: 12px; width: 200px; font-size: 1.2rem;">
        <button id="joinBtn" class="btn btn-primary">å‚åŠ </button>
      </div>
      <p class="text-muted text-sm">ã‚³ãƒ¼ãƒ‰ã¯è‹±æ•°å­—6æ–‡å­—ï¼ˆä¾‹: ABCD23ï¼‰</p>
    </div>
    <script>window.__PAGE_MODE__ = "room-join";</script>

    {% elif mode == "play" %}
    <div class="grid-dashboard" style="grid-template-columns: 2fr 1fr;">
      <!-- Left Column: Game Area -->
      <div class="flex-col gap-4">
        <div class="card">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h1 class="text-xl font-bold">å¯¾æˆ¦ä¸­ <span class="text-muted text-sm">#{{ code }}</span></h1>
              <div class="text-muted text-sm" id="roundInfo"></div>
            </div>
            <div class="flex gap-2">
              <button id="startBtn" class="btn btn-primary">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
              <button id="buzzBtn" class="btn btn-secondary" style="border-color: #ef4444; color: #ef4444;">æ—©æŠ¼ã—</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 id="qStem" class="text-xl font-bold mb-4" style="min-height: 3rem;">å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</h2>

          <div id="qTimerWrap" class="mb-4" style="display:none;">
            <div class="flex justify-between text-sm text-muted mb-1">
              <span>å›ç­”æ™‚é–“</span>
              <span id="qTimeLabel">--.- ç§’</span>
            </div>
            <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
              <div id="qTimeBar"
                style="height: 100%; background: var(--primary); width: 100%; transition: width 0.1s linear;"></div>
            </div>
          </div>

          <div id="qHintBox">
            <div id="qHintLabel">
              <span class="icon">ğŸ’¡</span><span>ãƒ’ãƒ³ãƒˆ</span>
            </div>
            <div id="qHintText"></div>
          </div>

          <div id="choices" class="flex-col gap-2">
            <!-- Choices injected by JS -->
          </div>
        </div>
      </div>

      <!-- Right Column: Score & Members -->
      <div class="flex-col gap-4">
        <div class="card">
          <h2 class="text-lg font-bold mb-4">ã‚¹ã‚³ã‚¢</h2>
          <div id="scoreboard" class="flex-col gap-2"></div>
          <div style="height: 1px; background: var(--card-border); margin: 16px 0;"></div>
          <h2 class="text-lg font-bold mb-4">å‚åŠ è€…</h2>
          <div id="members" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>

    <!-- Floating Stamp Panel -->
    <div id="stampFloat" class="stamp-fab">
      <div class="stamp-fab-header">
        <div class="text-sm font-bold">ã‚¹ã‚¿ãƒ³ãƒ—</div>
        <div class="flex items-center gap-2">
          <small class="text-muted">CDã‚ã‚Š</small>
          <button id="stampToggleBtn" class="btn btn-sm btn-secondary"
            style="padding: 4px 8px; font-size: 0.75rem;">ãŸãŸã‚€</button>
        </div>
      </div>
      <div class="stamp-fab-body">
        <div id="stampFloatGrid" class="stamp-grid"></div>
      </div>
    </div>

    <script>
      window.__PAGE_MODE__ = "play"; window.__ROOM_CODE__ = "{{ code }}";
      window.__IS_RANDOM__ = {{ 'true' if is_random else 'false' }};
    </script>
    {% endif %}

    <!-- Full Screen Overlay for Messages -->
    <div id="overlay" style="
      position: fixed; inset: 0; display: none; place-items: center;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 2000;">
      <div id="overlayContent" class="text-white font-bold text-center"
        style="font-size: clamp(32px,6vw,72px); text-shadow: 0 4px 16px rgba(0,0,0,.6);">
      </div>
    </div>

    <!-- O/X Feedback Overlay -->
    <div id="feedbackOverlay" class="feedback-overlay">
      <div id="feedbackMark" class="feedback-mark"></div>
    </div>

  </main>

  <script>
    window.__PAGE_MODE__ = {{ mode | tojson }};
    window.__ROOM_CODE__ = {{ code | tojson }};
    window.__IS_RANDOM__ = {{ (is_random | default (false)) | tojson }};
    window.__USER__ = {{
      {
        "id": user.id if user else 0,
          "email": user.email if user else None,
            "display_name": (user.display_name if user else None),
        "is_guest": (user.is_guest if user else True)
      } | tojson | safe
    }};
  </script>
  <script src="/static/quiz.js"></script>
</body>

</html>