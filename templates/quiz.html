<!-- templates/quiz.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¯ã‚¤ã‚º | Ishikawa Facilities & Parks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8fafc; }
    .card { border: 0; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.06); }
    .blinker { animation: bl 1s linear infinite; }
    @keyframes bl { 50% { opacity: .3; } }
    .member-pill { border-radius: 999px; background: #eef2ff; padding: .25rem .6rem; font-size: .9rem; }
    .choice-btn { text-align: left; }
    .choice-correct { border: 2px solid #22c55e !important; }
    .choice-wrong { opacity: 0.6; }
    .score-row { display:flex; justify-content:space-between; padding:.25rem .5rem; background:#fff; border:1px solid #eee; border-radius:.5rem; }

    /* â˜… ãƒ’ãƒ³ãƒˆç”¨ãƒœãƒƒã‚¯ã‚¹ */
    #qHintBox {
      border-radius: .75rem;
      border: 1px solid #bfdbfe;
      background: #eff6ff;
      padding: .6rem .8rem;
      display: none; /* JSã§4ç§’å¾Œã«è¡¨ç¤º */
    }
    #qHintLabel {
      font-size: .85rem;
      font-weight: 700;
      color: #1d4ed8;
      display: flex;
      align-items: center;
      gap: .35rem;
      margin-bottom: .25rem;
    }
    #qHintLabel span.icon {
      font-size: 1rem;
    }
    #qHintText {
      font-size: .9rem;
      color: #1e293b;
    }
        
    .stamp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: .5rem; }
    .stamp-btn { border: 1px solid #eee; border-radius: .5rem; background:#fff; padding:.25rem; cursor:pointer; }
    .stamp-btn img { width: 100%; height: auto; display:block; }
    .stamp-btn:disabled { opacity: .5; cursor: not-allowed; }

    /* ç”»é¢ä¸­å¤®ã§ãµã‚ã£ã¨è¡¨ç¤ºã•ã‚Œã‚‹æ¼”å‡º */
    .stamp-fx{
      position: fixed;
      z-index: 3000;
      pointer-events: none;
      opacity: 0;
      /* å¹…ã¯â€œãƒ‘ãƒãƒ«å¹…ã® ~90%ï¼ˆæœ€å¤§200pxï¼‰â€ã‚’JSã§è¨­å®šã€‚ã“ã“ã¯ fallback */
      width: 160px;
      animation: pop-float 850ms ease-out forwards;
    }
    @keyframes pop-float{
      0%   { opacity: 0; transform: translateY(8px) scale(0.9); }
      20%  { opacity: 1; transform: translateY(0)   scale(1.0); }
      100% { opacity: 0; transform: translateY(-10px) scale(1.0); }
    }


    /* === Stamp floating panel (bottom-right) === */
    .stamp-fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 2500;
      width: 280px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: .75rem;
      box-shadow: 0 12px 32px rgba(0,0,0,.15);
      overflow: hidden;
      display: none; /* jsã§è¡¨ç¤º */
    }
    .stamp-fab-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: .5rem .75rem; background: #f8fafc; border-bottom: 1px solid #eef2ff;
    }
    .stamp-fab-body {
      max-height: 50vh; overflow: auto; padding: .75rem;
    }
    @media (max-width: 992px) {
      .stamp-fab { right: 8px; left: 8px; width: auto; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/home">Ishikawa Facilities & Parks</a>
      <div class="ms-auto">
        <a class="btn btn-outline-secondary btn-sm" href="/home">ãƒ›ãƒ¼ãƒ ã¸</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    {% if mode == "random-wait" %}
      <div class="card p-4">
        <h1 class="h4">ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒå¾…æ©Ÿä¸­ <span class="blinker">â—</span></h1>
        <p class="text-muted mb-3">äººæ•°ãŒæƒã„æ¬¡ç¬¬ã€è‡ªå‹•ã§å¯¾æˆ¦éƒ¨å±‹ã«ç§»å‹•ã—ã¾ã™ã€‚</p>
        <div class="d-flex gap-2">
          <button id="cancelBtn" class="btn btn-outline-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
      <script>window.__PAGE_MODE__="random-wait";</script>

    {% elif mode == "room-created" %}
      <div class="card p-4">
        <h1 class="h4">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒãƒƒãƒã®éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸ</h1>
        <p class="mb-2">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å‹ã ã¡ã«å…±æœ‰ã—ã¦ãã ã•ã„ï¼š</p>
        <div class="input-group mb-3" style="max-width: 360px;">
          <input id="roomCode" class="form-control" value="{{ code }}" readonly>
          <button id="copyBtn" class="btn btn-outline-primary">ã‚³ãƒ”ãƒ¼</button>
        </div>
        <a class="btn btn-primary" href="/quiz?code={{ code }}">éƒ¨å±‹ã«å…¥ã‚‹</a>
      </div>
      <script>window.__PAGE_MODE__="room-created"; window.__ROOM_CODE__="{{ code }}";</script>

    {% elif mode == "room-join" %}
      <div class="card p-4">
        <h1 class="h4">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒãƒƒãƒã«å‚åŠ </h1>
        <div class="input-group mb-3" style="max-width: 360px;">
          <input id="joinCode" class="form-control" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
          <button id="joinBtn" class="btn btn-primary">å‚åŠ </button>
        </div>
        <p class="text-muted">ã‚³ãƒ¼ãƒ‰ã¯è‹±æ•°å­—6æ–‡å­—ï¼ˆä¾‹: ABCD23ï¼‰</p>
      </div>
      <script>window.__PAGE_MODE__="room-join";</script>

    {% elif mode == "play" %}
      <div class="row g-3">
        <div class="col-lg-8">
          <div class="card p-4 mb-3">
            <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
              <div>
                <h1 class="h4 mb-0">å¯¾æˆ¦ä¸­ <span class="text-muted">#{{ code }}</span></h1>
                <div class="text-muted" id="roundInfo"></div>
              </div>
              <div class="d-flex gap-2">
                <button id="startBtn" class="btn btn-success">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                <button id="buzzBtn" class="btn btn-outline-danger">æ—©æŠ¼ã—</button>
              </div>
            </div>
          </div>

          <div class="card p-4 mb-3">
            <h2 id="qStem" class="h5 mb-3">å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</h2>
            <div id="qHintBox" class="mb-3">
              <div id="qHintLabel">
                <span class="icon">ğŸ’¡</span><span>ãƒ’ãƒ³ãƒˆ</span>
              </div>
              <div id="qHintText"></div>
            </div>
            <div id="choices" class="d-grid gap-2">
              <!-- 4æŠãƒœã‚¿ãƒ³ -->
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card p-3">
            <h2 class="h6">ã‚¹ã‚³ã‚¢</h2>
            <div id="scoreboard" class="d-flex flex-column gap-2"></div>
            <hr>
            <h2 class="h6">å‚åŠ è€…</h2>
            <div id="members" class="d-flex flex-wrap gap-2"></div>
          </div>
        </div>
      </div>

      <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—ãƒ‘ãƒãƒ«ï¼ˆå³ä¸‹ï¼‰ -->
      <div id="stampFloat" class="stamp-fab">
        <div class="stamp-fab-header">
          <div class="small fw-bold">ã‚¹ã‚¿ãƒ³ãƒ—</div>
          <div class="d-flex align-items-center gap-2">
            <small class="text-muted">CDã‚ã‚Š</small>
            <button id="stampToggleBtn" class="btn btn-sm btn-outline-secondary">ãŸãŸã‚€</button>
          </div>
        </div>
        <div class="stamp-fab-body">
          <div id="stampFloatGrid" class="stamp-grid"></div>
        </div>
      </div>

      <script>
        window.__PAGE_MODE__="play"; window.__ROOM_CODE__="{{ code }}";
        window.__IS_RANDOM__={{ 'true' if is_random else 'false' }};
      </script>
    {% endif %}

    <div id="overlay" style="
      position: fixed; inset: 0; display: none; place-items: center;
      background: rgba(0,0,0,0.35); z-index: 2000;">
      <div id="overlayContent" class="text-white fw-bold" style="font-size: clamp(32px,6vw,72px); text-shadow: 0 4px 16px rgba(0,0,0,.6);">
      </div>
    </div>
  </main>

  <script>
    window.__PAGE_MODE__ = {{ mode | tojson }};
    window.__ROOM_CODE__ = {{ code | tojson }};
    window.__IS_RANDOM__ = {{ (is_random | default(false)) | tojson }};
    window.__USER__      = {{ {
      "id": user.id if user else 0,
      "email": user.email if user else None,
      "display_name": (user.display_name if user else None),
      "is_guest": (user.is_guest if user else True)
    } | tojson | safe }};
  </script>
  <script src="/static/quiz.js"></script>
</body>
</html>
