<!-- templates/quiz.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¯ã‚¤ã‚º | Ishikawa Facilities & Parks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --bg: #f3f4ff;
      --panel-bg: #ffffff;
      --accent: #6366f1;
      --accent-soft: #4f46e5;
      --card-radius: 1rem;
      --shadow-soft: 0 10px 30px rgba(15,23,42,0.10);
      --border-subtle: rgba(148,163,184,0.45);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #e0f2fe 0, #f5f3ff 30%, #f9fafb 70%);
      min-height: 100vh;
      color: #0f172a;
    }

    /* ===== ãƒŠãƒ“ãƒãƒ¼ï¼ˆhome.htmlã¨åˆã‚ã›ã‚‹ï¼‰ ===== */
    .navbar {
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.96) !important;
      border-bottom: 1px solid rgba(148,163,184,0.45);
    }
    .brand-mark {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      font-weight: 800;
      letter-spacing: .02em;
    }
    .brand-logo {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: conic-gradient(from 160deg, #22c55e, #0ea5e9, #6366f1, #22c55e);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .85rem;
      color: #fff;
      box-shadow: 0 0 0 2px #e5e7eb;
    }

    /* ===== å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
    main.quiz-root {
      padding-top: 1.5rem;
      padding-bottom: 2.5rem;
    }
    .quiz-layout {
      max-width: 980px;
      margin: 0 auto;
    }

    .card {
      border: 0;
      border-radius: 1rem;
      box-shadow: var(--shadow-soft);
      background: #ffffff;
    }

    .blinker { animation: bl 1s linear infinite; color: #22c55e; }
    @keyframes bl { 50% { opacity: .3; } }

    .member-pill {
      border-radius: 999px;
      background: #eef2ff;
      padding: .25rem .6rem;
      font-size: .9rem;
      border: 1px solid rgba(148,163,184,0.4);
    }

    .choice-btn { text-align: left; }
    .choice-correct { border: 2px solid #22c55e !important; }
    .choice-wrong { opacity: 0.6; }

    .score-row {
      display:flex;
      justify-content:space-between;
      padding:.25rem .5rem;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:.5rem;
      font-size: .85rem;
      position: relative;
    }
    /* ã‚¹ã‚³ã‚¢è¡Œã‚’é§…ã£ã½ãã™ã‚‹ */
    .score-row::before {
      content:"";
      position:absolute;
      left:-1.1rem;
      top:50%;
      width:12px;
      height:12px;
      border-radius:999px;
      background:#ffffff;
      border:3px solid #4f46e5;
      box-shadow:0 0 0 3px rgba(191,219,254,0.8);
      transform:translateY(-50%);
    }

    /* ã‚¹ã‚³ã‚¢ã€Œç·šè·¯ã€ãƒ©ãƒƒãƒ‘ãƒ¼ */
    .score-wrapper {
      position: relative;
      padding-left: 1.6rem;
    }
    .score-line {
      position: absolute;
      left: 0.55rem;
      top: 0.4rem;
      bottom: 0.4rem;
      width: 3px;
      border-radius: 999px;
      background: linear-gradient(to bottom, #4f46e5, #22c55e);
      opacity: .9;
    }

    /* ===== ãƒ—ãƒ¬ã‚¤ä¸­ã®å°ã•ãªãƒ©ãƒ™ãƒ« ===== */
    .quiz-tagline-sm {
      font-size: .78rem;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: #6366f1;
      font-weight: 700;
      margin-bottom: .15rem;
    }

    /* é€šå¸¸ãƒ—ãƒ¬ã‚¤ã‚«ãƒ¼ãƒ‰ */
    .play-card {
      position: relative;
      background: #ffffff;
    }
    /* ãƒœã‚¹æˆ¦ç”¨ãƒ—ãƒ¬ã‚¤ã‚«ãƒ¼ãƒ‰ï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰æ™‚ï¼‰ */
    .play-card-boss {
      border: 1px solid rgba(248,113,113,0.7);
      background:
        radial-gradient(circle at 0% 0%, #fee2e2 0, #fff7ed 45%, #ffffff 100%);
      box-shadow: 0 18px 40px rgba(248,113,113,0.4);
    }

    /* ===== ãƒ’ãƒ³ãƒˆç”¨ãƒœãƒƒã‚¯ã‚¹ ===== */
    #qHintBox {
      border-radius: .75rem;
      border: 1px solid #bfdbfe;
      background: #eff6ff;
      padding: .6rem .8rem;
      display: none; /* JSã§è¡¨ç¤ºåˆ¶å¾¡ */
    }
    #qHintLabel {
      font-size: .85rem;
      font-weight: 700;
      color: #1d4ed8;
      display: flex;
      align-items: center;
      gap: .35rem;
      margin-bottom: .25rem;
    }
    #qHintLabel span.icon {
      font-size: 1rem;
    }
    #qHintText {
      font-size: .9rem;
      color: #1e293b;
    }

    /* ===== ã‚¹ã‚¿ãƒ³ãƒ—UI ===== */
    .stamp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: .5rem; }
    .stamp-btn {
      border: 1px solid #e5e7eb;
      border-radius: .5rem;
      background:#ffffff;
      padding:.25rem;
      cursor:pointer;
    }
    .stamp-btn img { width: 100%; height: auto; display:block; }
    .stamp-btn:disabled { opacity: .5; cursor: not-allowed; }

    .stamp-fx{
      position: fixed;
      z-index: 3000;
      pointer-events: none;
      opacity: 0;
      width: 160px;
      animation: pop-float 850ms ease-out forwards;
    }
    @keyframes pop-float{
      0%   { opacity: 0; transform: translateY(8px) scale(0.9); }
      20%  { opacity: 1; transform: translateY(0)   scale(1.0); }
      100% { opacity: 0; transform: translateY(-10px) scale(1.0); }
    }

    .stamp-fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 2500;
      width: 280px;
      background: #ffffff;
      border: 1px solid rgba(148,163,184,0.7);
      border-radius: .9rem;
      box-shadow: 0 16px 40px rgba(15,23,42,.18);
      overflow: hidden;
      display: none;
    }
    .stamp-fab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: .5rem .75rem;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
    }
    .stamp-fab-body {
      max-height: 50vh;
      overflow: auto;
      padding: .75rem;
      background: #f9fafb;
    }
    @media (max-width: 992px) {
      .stamp-fab { right: 8px; left: 8px; width: auto; }
    }

    /* ===== ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒœã‚¹é¸æŠï¼‰: å…‰ã‚µãƒ¼ã‚¯ãƒ«èƒŒæ™¯ ===== */
    .challenge-hero {
      position: relative;
      overflow: hidden;
      border-radius: 1.2rem;
      background: radial-gradient(circle at 0% 0%, #e0f2fe 0, #f5f3ff 40%, #f9fafb 100%);
      padding: 1.8rem 1.6rem 1.5rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(129,140,248,0.45);
      margin-bottom: 1.5rem;
    }
    .challenge-label {
      font-size: .75rem;
      letter-spacing: .25em;
      text-transform: uppercase;
      color: #6366f1;
      font-weight: 700;
      margin-bottom: .35rem;
    }
    .challenge-title {
      font-size: 1.4rem;
      font-weight: 800;
      margin-bottom: .4rem;
    }
    .challenge-title span {
      background: linear-gradient(110deg,#6366f1,#ec4899);
      -webkit-background-clip: text;
      color: transparent;
    }
    .challenge-sub {
      font-size: .9rem;
      color: #4b5563;
      max-width: 34rem;
      margin-bottom: .7rem;
    }
    .challenge-meta {
      display: flex;
      flex-wrap: wrap;
      gap: .4rem .75rem;
      font-size: .78rem;
      color: #6b7280;
    }
    .challenge-meta span {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      padding: .2rem .55rem;
      border-radius: 999px;
      background: #eff6ff;
      border: 1px solid rgba(129,140,248,0.5);
    }

    .boss-row {
      display: grid;
      grid-template-columns: repeat(1, minmax(0,1fr));
      gap: 1rem;
    }
    @media (min-width: 768px) {
      .boss-row { grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    .boss-card {
      position: relative;
      border-radius: 1.2rem;
      background: #ffffff;
      border: 1px solid rgba(148,163,184,0.5);
      box-shadow: 0 12px 30px rgba(148,163,184,0.4);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 260px;
    }
    .boss-inner {
      position: relative;
      padding: .85rem .9rem .75rem;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: .4rem;
    }
    .boss-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: .5rem;
    }
    .boss-tag {
      font-size: .7rem;
      letter-spacing: .18em;
      text-transform: uppercase;
      padding: .2rem .7rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #1f2937;
      border: 1px solid rgba(129,140,248,0.8);
    }
    .boss-name {
      font-size: 1.05rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: .3rem;
    }
    .boss-name small {
      font-size: .75rem;
      color: #6b7280;
    }

    .boss-diff {
      font-size: .8rem;
      padding: .25rem .6rem;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      border: 1px solid;
      background: #fff;
    }
    .boss-diff.easy   { border-color: #22c55e33; color:#15803d; background:#dcfce7; }
    .boss-diff.normal { border-color: #3b82f633; color:#1d4ed8; background:#dbeafe; }
    .boss-diff.hard   { border-color: #f9731633; color:#b91c1c; background:#fee2e2; }

    .boss-visual {
      position: relative;
      margin: .3rem 0 .5rem;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .boss-bg-circle {
      position: absolute;
      width: 140px;
      height: 140px;
      border-radius: 999px;
      opacity: 0.9;
    }
    .boss-bg-circle.jack {
      background: radial-gradient(circle at 30% 20%, #bbf7d0 0, #4ade80 35%, #fefce8 70%);
    }
    .boss-bg-circle.queen {
      background: radial-gradient(circle at 30% 20%, #f9a8d4 0, #fb7185 35%, #fdf2f8 70%);
    }
    .boss-bg-circle.king {
      background: radial-gradient(circle at 30% 20%, #bfdbfe 0, #818cf8 35%, #e0f2fe 75%);
    }
    .boss-portrait {
      position: relative;
      max-height: 140px;
      object-fit: contain;
      filter: drop-shadow(0 10px 18px rgba(15,23,42,0.25));
    }

    .boss-text {
      font-size: .82rem;
      color: #4b5563;
    }
    .boss-stats {
      display: flex;
      flex-direction: column;
      gap: .25rem;
      font-size: .78rem;
      color: #374151;
      margin-top: .15rem;
    }
    .boss-stat-row {
      display: flex;
      align-items: center;
      gap: .4rem;
    }
    .boss-stat-label {
      min-width: 3.5rem;
      color: #9ca3af;
    }
    .boss-stat-bar {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }
    .boss-stat-fill {
      height: 100%;
      border-radius: inherit;
    }
    .boss-stat-fill.jack-speed   { width: 45%; background: linear-gradient(to right,#22c55e,#a3e635); }
    .boss-stat-fill.jack-accur   { width: 55%; background: linear-gradient(to right,#22c55e,#a3e635); }
    .boss-stat-fill.queen-speed  { width: 70%; background: linear-gradient(to right,#3b82f6,#6366f1); }
    .boss-stat-fill.queen-accur  { width: 75%; background: linear-gradient(to right,#3b82f6,#6366f1); }
    .boss-stat-fill.king-speed   { width: 92%; background: linear-gradient(to right,#f97316,#ef4444); }
    .boss-stat-fill.king-accur   { width: 96%; background: linear-gradient(to right,#f97316,#ef4444); }

    .boss-footer {
      padding: .6rem .9rem .8rem;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
    }
    .boss-footer small {
      font-size: .74rem;
      color: #6b7280;
    }

    /* ===== ãƒœã‚¹æˆ¦ HUD (YOU vs BOSS) ===== */
    .boss-hud {
      display: flex;
      align-items: center;
      gap: .75rem;
      margin-top: .25rem;
      margin-bottom: .5rem;
    }
    .boss-hud-side {
      flex: 1;
      padding: .45rem .6rem;
      border-radius: .75rem;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.03);
      backdrop-filter: blur(6px);
    }
    .boss-hud-player {
      background: radial-gradient(circle at 0% 0%, #dcfce7 0, #f0fdf4 40%, #ffffff 100%);
    }
    .boss-hud-boss.jack {
      background: radial-gradient(circle at 0% 0%, #bbf7d0 0, #4ade80 40%, #fefce8 95%);
    }
    .boss-hud-boss.queen {
      background: radial-gradient(circle at 0% 0%, #f9a8d4 0, #fb7185 40%, #fdf2f8 95%);
    }
    .boss-hud-boss.king {
      background: radial-gradient(circle at 0% 0%, #bfdbfe 0, #818cf8 40%, #e0f2fe 95%);
    }
    .boss-hud-label {
      font-size: .7rem;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: #6b7280;
      font-weight: 700;
      margin-bottom: .1rem;
    }
    .boss-hud-name {
      font-size: .9rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: .35rem;
    }
    .boss-hud-name span.icon {
      font-size: 1.1rem;
    }
    .boss-hud-bar {
      margin-top: .2rem;
      height: 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.06);
      overflow: hidden;
    }
    .boss-hud-fill {
      height: 100%;
      border-radius: 999px;
    }
    /* â˜… HPã‚²ãƒ¼ã‚¸ã¯æœ€åˆãƒ•ãƒ«ï¼ˆ100%ï¼‰ã«ã—ã¦ãŠã */
    .boss-hud-fill.player { width: 100%; background: linear-gradient(to right,#22c55e,#a3e635); }
    .boss-hud-fill.boss   { width: 100%; background: linear-gradient(to right,#f97316,#ef4444); }

    .boss-hud-vs {
      font-weight: 900;
      font-size: .95rem;
      padding: .2rem .4rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      color: #fefce8;
      box-shadow: 0 0 0 3px rgba(248,250,252,0.8);
    }

    /* ===== ã‚¯ã‚¤ã‚º ã‚ãã³ã‹ãŸï¼ˆhome.html ã¨å…±é€šãƒ†ã‚¤ã‚¹ãƒˆï¼‰ ===== */
    .tutorial-backdrop {
      position: fixed;
      inset: 0;
      display: none;              /* JSã§è¡¨ç¤ºåˆ¶å¾¡ */
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 1.5rem;
      background: radial-gradient(
        circle at top,
        rgba(15,23,42,0.75) 0,
        rgba(15,23,42,0.85) 45%,
        rgba(15,23,42,0.9) 100%
      );
    }

    .tutorial-card {
      background: #ffffff;
      border-radius: 1.25rem;
      max-width: 720px;
      width: 92%;
      box-shadow: 0 24px 60px rgba(15,23,42,0.55);
      padding: 1.6rem 1.8rem 1.3rem;
      position: relative;
      border: 1px solid rgba(148,163,184,0.45);
    }

    /* è¦‹å‡ºã—ã¾ã‚ã‚Šï¼ˆhome ã® home-tutorial-* ã¨åŒã˜ãƒˆãƒ¼ãƒ³ï¼‰ */
    .tutorial-badge {
      font-size: .75rem;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: #6366f1;
      font-weight: 700;
      margin-bottom: .3rem;
    }

    .tutorial-title {
      font-size: 1.25rem;
      font-weight: 800;
      margin-bottom: .4rem;
    }

    .tutorial-title span {
      background: linear-gradient(110deg,#6366f1,#f97316);
      -webkit-background-clip: text;
      color: transparent;
    }

    /* æœ¬æ–‡ãƒ»ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ */
    .tutorial-body {
      margin-top: .6rem;
      margin-bottom: .8rem;
      font-size: .94rem;
      color: #4b5563;
      min-height: 130px;
    }

    .tutorial-page {
      display: none;
    }

    .tutorial-page.active {
      display: block;
    }

    /* ãƒ•ãƒƒã‚¿ãƒ¼éƒ¨åˆ†ï¼ˆã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºï¼‹ãƒœã‚¿ãƒ³ç¾¤ï¼‰ */
    .tutorial-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .75rem;
      margin-top: .75rem;
      padding-top: .6rem;
      border-top: 1px solid #e5e7eb;
    }

    .tutorial-steps {
      font-size: .8rem;
      color: #6b7280;
    }

    /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã¯ pill å½¢çŠ¶ */
    .tutorial-close-btn {
      border-radius: 999px;
    }

    /* ã€Œæ¬¡å›ã‹ã‚‰è‡ªå‹•è¡¨ç¤ºã—ãªã„ã€ */
    .tutorial-checkbox {
      font-size: .78rem;
      color: #6b7280;
      margin-top: .45rem;
      display: flex;
      align-items: center;
      gap: .3rem;
    }

  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand brand-mark" href="/home">
        <span class="brand-logo">IF</span>
        <span>Ishikawa Facilities &amp; Parks</span>
      </a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <button id="helpBtn" class="btn btn-outline-primary btn-sm">
          â“ ã‚ãã³ã‹ãŸ
        </button>
        <a class="btn btn-outline-secondary btn-sm" href="/home">ãƒ›ãƒ¼ãƒ ã¸</a>
      </div>
    </div>
  </nav>

  <main class="quiz-root">
    <div class="quiz-layout container">

      {% if mode == "random-wait" %}
      <!-- ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒå¾…æ©Ÿ -->
      <div class="card p-4">
        <h1 class="h4 mb-2">
          ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒå¾…æ©Ÿä¸­ <span class="blinker">â—</span>
        </h1>
        <p class="text-muted mb-3">
          ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨è‡ªå‹•ã§ãƒãƒƒãƒãƒ³ã‚°ä¸­ã§ã™ã€‚  
          äººæ•°ãŒæƒã„æ¬¡ç¬¬ã€ãã®ã¾ã¾å¯¾æˆ¦éƒ¨å±‹ã«ç§»å‹•ã—ã¾ã™ã€‚
        </p>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <button id="cancelBtn" class="btn btn-outline-secondary">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
          </button>
          <span class="small text-muted">â€» ã“ã®ã¾ã¾æ”¾ç½®ã—ã¦ã„ã¦ã‚‚ãƒãƒƒãƒãƒ³ã‚°ã¯ç¶šãã¾ã™ã€‚</span>
        </div>
      </div>
      <script>window.__PAGE_MODE__="random-wait";</script>

      {% elif mode == "room-created" %}
      <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒãƒƒãƒï¼šéƒ¨å±‹ä½œæˆ -->
      <div class="card p-4">
        <h1 class="h4 mb-3">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒãƒƒãƒã®éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸ</h1>
        <p class="mb-2 text-muted">
          ä¸‹ã®ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’ã€ã„ã£ã—ã‚‡ã«éŠã¶å‹ã ã¡ã«å…±æœ‰ã—ã¦ãã ã•ã„ã€‚
        </p>
        <div class="input-group mb-3" style="max-width: 360px;">
          <input id="roomCode" class="form-control" value="{{ code }}" readonly>
          <button id="copyBtn" class="btn btn-outline-primary">ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <a class="btn btn-primary" href="/quiz?code={{ code }}">è‡ªåˆ†ã‚‚éƒ¨å±‹ã«å…¥ã‚‹</a>
          <span class="small text-muted">â€» å‚åŠ è€…ãŒæƒã£ãŸã‚‰ã€éƒ¨å±‹ç”»é¢ã®ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚</span>
        </div>
      </div>
      <script>
        window.__PAGE_MODE__="room-created";
        window.__ROOM_CODE__="{{ code }}";
      </script>

      {% elif mode == "room-join" %}
      <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒãƒƒãƒï¼šéƒ¨å±‹å‚åŠ  -->
      <div class="card p-4">
        <h1 class="h4 mb-3">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒãƒƒãƒã«å‚åŠ </h1>
        <p class="text-muted">
          å‹ã ã¡ã‹ã‚‰æ•™ãˆã¦ã‚‚ã‚‰ã£ãŸ 6 æ–‡å­—ã®ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </p>
        <div class="input-group mb-3" style="max-width: 360px;">
          <input id="joinCode" class="form-control" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆä¾‹: ABCD23ï¼‰">
          <button id="joinBtn" class="btn btn-primary">å‚åŠ </button>
        </div>
        <p class="text-muted small mb-0">
          â€» åŠè§’è‹±æ•°å­—ã®ã¿ã€‚å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã®é•ã„ã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚
        </p>
      </div>
      <script>window.__PAGE_MODE__="room-join";</script>

      {% elif mode == "challenge-select" %}
      <!-- ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰ï¼šãƒœã‚¹é¸æŠï¼ˆå…‰ã‚µãƒ¼ã‚¯ãƒ«èƒŒæ™¯ï¼‰ -->
      <div class="challenge-hero">
        <div class="challenge-label">CHALLENGE MODE</div>
        <div class="challenge-title"><span>1 vs 1 ãƒœã‚¹ãƒãƒˆãƒ«ã«æŒ‘æˆ¦ï¼</span></div>
        <p class="challenge-sub">
          ã‚¸ãƒ£ãƒƒã‚¯ãƒ»ã‚¯ã‚¤ãƒ¼ãƒ³ãƒ»ã‚­ãƒ³ã‚°ã€3ä½“ã®CPUãƒœã‚¹ãŒã‚ãªãŸã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚  
          ãã‚Œãã‚Œã€Œåå¿œé€Ÿåº¦ã€ã¨ã€Œæ­£è§£ç‡ã€ãŒé•ã†ã®ã§ã€è‡ªåˆ†ã®å®ŸåŠ›ã‚„æ°—åˆ†ã«åˆã‚ã›ã¦é›£æ˜“åº¦ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
        </p>
        <div class="challenge-meta">
          <span>ğŸ¯ å…ˆã«æ­£è§£ã—ãŸæ–¹ãŒãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼ˆå…ˆç€ãƒœãƒ¼ãƒŠã‚¹ã‚ã‚Šï¼‰</span>
          <span>ğŸ•’ åˆ¶é™æ™‚é–“ã¤ãã§ãƒ†ãƒ³ãƒã‚ˆãé€²è¡Œ</span>
          <span>ğŸ§  ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã»ã©å•é¡Œã®å‚¾å‘ã«æ…£ã‚Œã¦ã„ãã¾ã™</span>
        </div>
      </div>

      <div class="boss-row mb-3">
        <!-- ã‚¸ãƒ£ãƒƒã‚¯ï¼šEASY -->
        <div class="boss-card">
          <div class="boss-inner">
            <div class="boss-header">
              <div>
                <div class="boss-tag">â™  JACK</div>
                <div class="boss-name">
                  ã‚¸ãƒ£ãƒƒã‚¯ <small>/ å…¥é–€ç”¨ãƒœã‚¹</small>
                </div>
              </div>
              <div class="boss-diff easy">
                <span>â˜…â˜†â˜†</span><span>ã‹ã‚“ãŸã‚“</span>
              </div>
            </div>

            <div class="boss-visual">
              <div class="boss-bg-circle jack"></div>
              <img src="/static/challenge/jack.png"
                   alt="ã‚¸ãƒ£ãƒƒã‚¯"
                   class="boss-portrait img-fluid">
            </div>

            <p class="boss-text mb-1">
              CPUã®åå¿œé€Ÿåº¦ã‚‚æ­£è§£ç‡ã‚‚ã²ã‹ãˆã‚ã€‚  
              ã¾ãšã¯ã“ã“ã§æ—©æŠ¼ã—ã®æ„Ÿè¦šã‚’ã¤ã‹ã‚“ã§ã¿ã¾ã—ã‚‡ã†ã€‚
            </p>

            <div class="boss-stats">
              <div class="boss-stat-row">
                <div class="boss-stat-label">ã‚¹ãƒ”ãƒ¼ãƒ‰</div>
                <div class="boss-stat-bar">
                  <div class="boss-stat-fill jack-speed"></div>
                </div>
              </div>
              <div class="boss-stat-row">
                <div class="boss-stat-label">æ­£ç¢ºã•</div>
                <div class="boss-stat-bar">
                  <div class="boss-stat-fill jack-accur"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="boss-footer">
            <a href="/quiz/challenge/play?level=jack" class="btn btn-sm btn-primary">
              ã‚¸ãƒ£ãƒƒã‚¯ã«æŒ‘æˆ¦
            </a>
            <small>åˆã‚ã¦ã®äººã«ãŠã™ã™ã‚ã€‚</small>
          </div>
        </div>

        <!-- ã‚¯ã‚¤ãƒ¼ãƒ³ï¼šNORMAL -->
        <div class="boss-card">
          <div class="boss-inner">
            <div class="boss-header">
              <div>
                <div class="boss-tag">â™¥ QUEEN</div>
                <div class="boss-name">
                  ã‚¯ã‚¤ãƒ¼ãƒ³ <small>/ æ¨™æº–ãƒœã‚¹</small>
                </div>
              </div>
              <div class="boss-diff normal">
                <span>â˜…â˜…â˜†</span><span>ãµã¤ã†</span>
              </div>
            </div>

            <div class="boss-visual">
              <div class="boss-bg-circle queen"></div>
              <img src="/static/challenge/queen.png"
                   alt="ã‚¯ã‚¤ãƒ¼ãƒ³"
                   class="boss-portrait img-fluid">
            </div>

            <p class="boss-text mb-1">
              åå¿œã‚‚æ—©ãã€æ­£è§£ç‡ã‚‚ã¾ãšã¾ãšã€‚  
              ã‚¸ãƒ£ãƒƒã‚¯ã§ã¯ç‰©è¶³ã‚Šãªããªã£ã¦ããŸã‚‰ã€æ¬¡ã¯ã‚¯ã‚¤ãƒ¼ãƒ³ã¸ã€‚
            </p>

            <div class="boss-stats">
              <div class="boss-stat-row">
                <div class="boss-stat-label">ã‚¹ãƒ”ãƒ¼ãƒ‰</div>
                <div class="boss-stat-bar">
                  <div class="boss-stat-fill queen-speed"></div>
                </div>
              </div>
              <div class="boss-stat-row">
                <div class="boss-stat-label">æ­£ç¢ºã•</div>
                <div class="boss-stat-bar">
                  <div class="boss-stat-fill queen-accur"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="boss-footer">
            <a href="/quiz/challenge/play?level=queen" class="btn btn-sm btn-warning">
              ã‚¯ã‚¤ãƒ¼ãƒ³ã«æŒ‘æˆ¦
            </a>
            <small>ã€Œæ­¯ã”ãŸãˆãŒã»ã—ã„ã€äººå‘ã‘ã€‚</small>
          </div>
        </div>

        <!-- ã‚­ãƒ³ã‚°ï¼šHARD -->
        <div class="boss-card">
          <div class="boss-inner">
            <div class="boss-header">
              <div>
                <div class="boss-tag">â—† KING</div>
                <div class="boss-name">
                  ã‚­ãƒ³ã‚° <small>/ æœ€çµ‚ãƒœã‚¹</small>
                </div>
              </div>
              <div class="boss-diff hard">
                <span>â˜…â˜…â˜…</span><span>ã‹ãªã‚Šãƒ ã‚ºã„</span>
              </div>
            </div>

            <div class="boss-visual">
              <div class="boss-bg-circle king"></div>
              <img src="/static/challenge/king.png"
                   alt="ã‚­ãƒ³ã‚°"
                   class="boss-portrait img-fluid">
            </div>

            <p class="boss-text mb-1">
              åå¿œé€Ÿåº¦ã¯ã¨ã¦ã‚‚é€Ÿãã€æ­£è§£ç‡ã‚‚ã»ã¼ã‚«ãƒ³ãƒšã‚­ã€‚  
              æ²¹æ–­ã™ã‚‹ã¨ä¸€ç¬ã§ãƒã‚¤ãƒ³ãƒˆã‚’æŒã£ã¦ã„ã‹ã‚Œã¾ã™ã€‚
            </p>

            <div class="boss-stats">
              <div class="boss-stat-row">
                <div class="boss-stat-label">ã‚¹ãƒ”ãƒ¼ãƒ‰</div>
                <div class="boss-stat-bar">
                  <div class="boss-stat-fill king-speed"></div>
                </div>
              </div>
              <div class="boss-stat-row">
                <div class="boss-stat-label">æ­£ç¢ºã•</div>
                <div class="boss-stat-bar">
                  <div class="boss-stat-fill king-accur"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="boss-footer">
            <a href="/quiz/challenge/play?level=king" class="btn btn-sm btn-danger">
              ã‚­ãƒ³ã‚°ã«æŒ‘æˆ¦
            </a>
            <small>è…•ã«è‡ªä¿¡ãŒã‚ã‚‹äººã ã‘ã©ã†ãã€‚</small>
          </div>
        </div>
      </div>

      <p class="text-muted small">
        â€» CPUã®å…·ä½“çš„ãªã€Œé€Ÿã•ã€ã‚„ã€Œæ­£è§£ç‡ã€ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã«ã‚ˆã‚Šèª¿æ•´ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
      </p>

      <script>window.__PAGE_MODE__="challenge-select";</script>

      {% elif mode == "play" %}
      {% set is_challenge = (challenge_level is defined and challenge_level) %}

      <!-- å¯¾æˆ¦ä¸­ç”»é¢ï¼ˆç·šè·¯ã‚¹ã‚³ã‚¢ï¼‹ãƒœã‚¹æˆ¦å¯¾å¿œï¼‰ -->
      <div class="row g-3">
        <div class="col-lg-8">
          <div class="card p-4 mb-3 play-card {% if is_challenge %}play-card-boss{% endif %}">
            <div class="d-flex flex-wrap justify-content-between align-items-start mb-2">
              <div class="me-3">
                {% if is_challenge %}
                  <div class="quiz-tagline-sm" style="color:#f97316;">BOSS BATTLE</div>
                  <h1 class="h5 mb-1">CPU ã¨ 1 vs 1 ã®ç™½ç†±ãƒãƒˆãƒ«</h1>
                  <div class="text-muted small mb-1">
                    ã€Œãƒœã‚¹æˆ¦ã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’æŠ¼ã™ã¨ãƒœã‚¹ã¨ã®å¯¾æˆ¦ãŒå§‹ã¾ã‚Šã¾ã™ã€‚
                  </div>
                  <div class="small fw-semibold" style="color:#b91c1c;">
                    VS
                    {% if challenge_level == "jack" %}
                      ã‚¸ãƒ£ãƒƒã‚¯
                    {% elif challenge_level == "queen" %}
                      ã‚¯ã‚¤ãƒ¼ãƒ³
                    {% elif challenge_level == "king" %}
                      ã‚­ãƒ³ã‚°
                    {% else %}
                      CPU
                    {% endif %}
                  </div>
                {% else %}
                  <div class="quiz-tagline-sm">ONLINE BATTLE</div>
                  <h1 class="h5 mb-1">çŸ³å· å…¬å…±æ–½è¨­ãƒ»å…¬åœ’ã‚¯ã‚¤ã‚º</h1>
                  <div class="text-muted small">
                    å‚åŠ è€…ãŒæƒã£ãŸã‚‰ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
                  </div>
                {% endif %}
                <div id="roundInfo" class="text-muted small mt-1"></div>
              </div>
              <div class="mt-2 mt-lg-0">
                <button id="startBtn"
                        class="btn {% if is_challenge %}btn-danger{% else %}btn-success{% endif %}">
                  {% if is_challenge %}
                    ãƒœã‚¹æˆ¦ã‚¹ã‚¿ãƒ¼ãƒˆ
                  {% else %}
                    ã‚²ãƒ¼ãƒ é–‹å§‹
                  {% endif %}
                </button>
              </div>
            </div>

            {% if is_challenge %}
            <!-- ãƒœã‚¹æˆ¦HUDï¼šYOU vs BOSS -->
            <div class="boss-hud">
              <div class="boss-hud-side boss-hud-player">
                <div class="boss-hud-label">YOU</div>
                <div class="boss-hud-name">
                  <span class="icon">ğŸ§‘â€ğŸ“</span>
                  <span>{{ user.display_name or user.email or "ã‚ãªãŸ" }}</span>
                </div>
                <div class="boss-hud-bar">
                  <!-- â˜… HPãƒãƒ¼ã«IDä»˜ã‘ -->
                  <div class="boss-hud-fill player" id="playerHpFill"></div>
                </div>
              </div>
              <div class="boss-hud-vs">VS</div>
              <div class="boss-hud-side boss-hud-boss boss-{{ challenge_level }}">
                <div class="boss-hud-label">BOSS</div>
                <div class="boss-hud-name">
                  {% if challenge_level == "jack" %}
                    <span class="icon">â—†</span><span>ã‚¸ãƒ£ãƒƒã‚¯</span>
                  {% elif challenge_level == "queen" %}
                    <span class="icon">â™¥</span><span>ã‚¯ã‚¤ãƒ¼ãƒ³</span>
                  {% elif challenge_level == "king" %}
                    <span class="icon">â™ </span><span>ã‚­ãƒ³ã‚°</span>
                  {% else %}
                    <span class="icon">ğŸ¤–</span><span>CPU</span>
                  {% endif %}
                </div>
                <div class="boss-hud-bar">
                  <!-- â˜… HPãƒãƒ¼ã«IDä»˜ã‘ -->
                  <div class="boss-hud-fill boss" id="bossHpFill"></div>
                </div>
              </div>
            </div>
            {% endif %}

            <hr class="my-3">

            <h2 id="qStem" class="h5 mb-3">å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</h2>

            <div id="qHintBox" class="mb-3">
              <div id="qHintLabel">
                <span class="icon">ğŸ’¡</span><span>ãƒ’ãƒ³ãƒˆ</span>
              </div>
              <div id="qHintText"></div>
            </div>

            <div id="choices" class="d-grid gap-2">
              <!-- 4æŠãƒœã‚¿ãƒ³ï¼ˆquiz.jsã§ç”Ÿæˆï¼‰ -->
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card p-3">
            <h2 class="h6 mb-2">ã‚¹ã‚³ã‚¢</h2>
            <div class="score-wrapper mb-3">
              <div class="score-line"></div>
              <div id="scoreboard" class="d-flex flex-column gap-2"></div>
            </div>
            <hr>
            <h2 class="h6 mb-2">å‚åŠ è€…</h2>
            <div id="members" class="d-flex flex-wrap gap-2"></div>
          </div>
        </div>
      </div>

      <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—ãƒ‘ãƒãƒ« -->
      <div id="stampFloat" class="stamp-fab">
        <div class="stamp-fab-header">
          <div class="small fw-bold">ã‚¹ã‚¿ãƒ³ãƒ—</div>
          <div class="d-flex align-items-center gap-2">
            <small class="text-muted">ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã‚ã‚Š</small>
            <button id="stampToggleBtn" class="btn btn-sm btn-outline-secondary">ãŸãŸã‚€</button>
          </div>
        </div>
        <div class="stamp-fab-body">
          <div id="stampFloatGrid" class="stamp-grid"></div>
        </div>
      </div>

      <!-- JSäº’æ›ç”¨ã®ãƒ€ãƒŸãƒ¼ï¼ˆç”»é¢ã«ã¯è¡¨ç¤ºã—ãªã„ï¼‰ -->
      <div style="display:none;">
        <button id="buzzBtn" type="button"></button>
        <span id="timerLabel"></span>
      </div>

      <script>
        window.__PAGE_MODE__="play";
        window.__ROOM_CODE__="{{ code }}";
        window.__IS_RANDOM__={{ 'true' if is_random else 'false' }};
      </script>
      {% endif %}

      <!-- WIN / LOSE ãªã©ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
      <div id="overlay" style="
        position: fixed; inset: 0; display: none; place-items: center;
        background: rgba(15,23,42,0.35); z-index: 2000;">
        <div id="overlayContent" class="text-white fw-bold"
             style="font-size: clamp(32px,6vw,72px); text-shadow: 0 4px 16px rgba(0,0,0,.6);">
        </div>
      </div>
    </div>
  </main>

  <!-- â–¼ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…¨ãƒ¢ãƒ¼ãƒ‰å…±é€šã§ä½¿ã†ï¼‰ -->
  <div id="tutorialBackdrop" class="tutorial-backdrop">
    <div class="tutorial-card">
      <div class="tutorial-badge">HOW TO PLAY</div>
      <div class="tutorial-title"><span>ã‚¯ã‚¤ã‚ºã®éŠã³æ–¹</span></div>

      <div class="tutorial-body">
        <!-- ãƒšãƒ¼ã‚¸1: ã‚¢ãƒ—ãƒªå…¨ä½“ -->
        <div class="tutorial-page active" data-page="1">
          <p class="mb-2">
            ã“ã®ã‚¢ãƒ—ãƒªã¯ã€<strong>çŸ³å·çœŒã®å…¬å…±æ–½è¨­ãƒ»å…¬åœ’</strong>ã«é–¢ã™ã‚‹ã‚¯ã‚¤ã‚ºã‚’é€šã—ã¦ã€è¡—ã®ã“ã¨ã‚’æ¥½ã—ãå­¦ã¹ã‚‹ã‚¢ãƒ—ãƒªã§ã™ã€‚
          </p>
          <ul class="mb-0">
            <li>ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒƒãƒï¼šå…¨å›½ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨è‡ªå‹•ãƒãƒƒãƒãƒ³ã‚°</li>
            <li>ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒãƒƒãƒï¼šãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ã¦å‹ã ã¡ã¨ãƒãƒˆãƒ«</li>
            <li>ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰ï¼šCPUãƒœã‚¹ã¨ã® 1 vs 1 ãƒãƒˆãƒ«</li>
          </ul>
        </div>

        <!-- ãƒšãƒ¼ã‚¸2: åŸºæœ¬ãƒ«ãƒ¼ãƒ« -->
        <div class="tutorial-page" data-page="2">
          <p class="mb-2">
            ã‚¯ã‚¤ã‚ºã¯<strong>4æŠ</strong>ã§ã€<strong>åˆ¶é™æ™‚é–“å†…ã«ç­”ãˆã‚’é¸ã¶</strong>æ—©æŠ¼ã—ã‚¹ã‚¿ã‚¤ãƒ«ã§ã™ã€‚
          </p>
          <ul class="mb-0">
            <li>æ­£è§£ã™ã‚‹ã¨ã‚¹ã‚³ã‚¢ãŒåŠ ç®—ã•ã‚Œã¾ã™ã€‚</li>
            <li><strong>æ—©ãæ­£è§£</strong>ã™ã‚‹ã»ã©é«˜å¾—ç‚¹ï¼ˆå…ˆç€ãƒœãƒ¼ãƒŠã‚¹ï¼‰ï¼</li>
            <li>ã¾ã¡ãŒãˆã¦ã‚‚æ¬¡ã®å•é¡Œã§æŒ½å›ã§ãã¾ã™ã€‚</li>
          </ul>
        </div>

        <!-- ãƒšãƒ¼ã‚¸3: ãƒœã‚¹æˆ¦ï¼†ã‚¹ã‚¿ãƒ³ãƒ— -->
        <div class="tutorial-page" data-page="3">
          <p class="mb-2">
            ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ã‚¸ãƒ£ãƒƒã‚¯ãƒ»ã‚¯ã‚¤ãƒ¼ãƒ³ãƒ»ã‚­ãƒ³ã‚°ã®<strong>CPUãƒœã‚¹</strong>ã¨å¯¾æˆ¦ã—ã¾ã™ã€‚
          </p>
          <ul class="mb-0">
            <li>æ­£è§£ãƒ»ä¸æ­£è§£ã«å¿œã˜ã¦ã€ãŠäº’ã„ã®<strong>HPãƒãƒ¼</strong>ãŒæ¸›ã£ã¦ã„ãã¾ã™ã€‚</li>
            <li>å…ˆã«ãƒœã‚¹ã®HPã‚’ 0 ã«ã™ã‚Œã°å‹åˆ©ã€ã‚ãªãŸã®HPãŒ 0 ã«ãªã‚‹ã¨æ•—åŒ—ã§ã™ã€‚</li>
            <li>ãƒ—ãƒ¬ã‚¤ä¸­ã¯ã‚¹ã‚¿ãƒ³ãƒ—ã§ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</li>
          </ul>
        </div>
      </div>

      <div class="tutorial-footer">
        <div class="tutorial-steps">
          <span id="tutorialStepLabel">1 / 3</span>
        </div>
        <div class="d-flex gap-2">
          <button id="tutorialPrevBtn" type="button" class="btn btn-outline-secondary btn-sm" disabled>
            æˆ»ã‚‹
          </button>
          <button id="tutorialNextBtn" type="button" class="btn btn-primary btn-sm">
            æ¬¡ã¸
          </button>
          <button id="tutorialCloseBtn" type="button" class="btn btn-outline-dark btn-sm tutorial-close-btn" style="display:none;">
            OK ã§ã¯ã˜ã‚ã‚‹
          </button>
        </div>
      </div>

      <label class="tutorial-checkbox">
        <input type="checkbox" id="tutorialDontShow" />
        æ¬¡å›ã‹ã‚‰è‡ªå‹•è¡¨ç¤ºã—ãªã„
      </label>
    </div>
  </div>

  <!-- â–¼ ã‚¯ã‚¤ã‚ºBGMï¼ˆå¾…æ©Ÿç³» & ãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠã ã‘ï¼‰ -->
  {% if mode in ["random-wait", "room-created", "room-join", "challenge-select"] %}
  <audio id="bgmAudio" loop>
    {% if mode == "challenge-select" %}
      <source src="/static/bgm/challenge.mp3" type="audio/mpeg">
    {% else %}
      <source src="/static/bgm/home_bgm2.mp3" type="audio/mpeg">
    {% endif %}
  </audio>
  <div style="position: fixed; right: 1rem; bottom: 1rem; z-index: 2000;">
    <button id="bgmToggleBtn" class="btn btn-sm btn-dark">
      ğŸµ BGM ON
    </button>
  </div>
  {% endif %}

  <!-- quiz.js ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”¨ã‚‚å«ã‚€ï¼‰ -->
  <script>
    window.__PAGE_MODE__ = {{ mode | tojson }};
    window.__ROOM_CODE__ = {{ code | tojson }};
    window.__IS_RANDOM__ = {{ (is_random | default(false)) | tojson }};
    window.__CHALLENGE_LEVEL__ = {{ (challenge_level | default(None)) | tojson }};
    window.__USER__ = {{ {
      "id": user.id if user else 0,
      "email": user.email if user else None,
      "display_name": (user.display_name if user else None),
      "is_guest": (user.is_guest if user else True)
    } | tojson | safe }};
  </script>

  <!-- â˜… HPç®¡ç†ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆ1/10ãšã¤æ¸›ã‚‰ã™ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ -->
  <script>
    (function() {
      const maxHp = 100;
      let playerHp = maxHp;
      let bossHp   = maxHp;

      const playerBar = document.getElementById('playerHpFill');
      const bossBar   = document.getElementById('bossHpFill');

      function renderHp() {
        if (playerBar) playerBar.style.width = playerHp + '%';
        if (bossBar)   bossBar.style.width   = bossHp   + '%';
      }

      // åˆæœŸåŒ–ï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿æ„å‘³ãŒã‚ã‚‹ãŒã€DOMã«ãƒãƒ¼ãŒã‚ã‚Œã°å‹•ãï¼‰
      function initBossBattleHp() {
        playerHp = maxHp;
        bossHp   = maxHp;
        renderHp();
      }

      // ãƒ¦ãƒ¼ã‚¶ãŒã€Œç›¸æ‰‹ã‚ˆã‚Šæ—©ãæ­£è§£ã€ã—ãŸã¨ã: ãƒœã‚¹HPã‚’1/10æ¸›ã‚‰ã™
      // ãã‚Œä»¥å¤–ï¼ˆè² ã‘orä¸æ­£è§£ï¼‰ã®ã¨ã: è‡ªåˆ†ã ã‘1/10æ¸›ã‚‰ã™
      function applyBossBattleRound(userFasterAndCorrect) {
        if (!playerBar || !bossBar) return; // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯ä½•ã‚‚ã—ãªã„

        if (userFasterAndCorrect) {
          bossHp = Math.max(0, bossHp - 10);
        } else {
          playerHp = Math.max(0, playerHp - 10);
        }
        renderHp();
      }

      window.initBossBattleHp     = initBossBattleHp;
      window.applyBossBattleRound = applyBossBattleRound;

      document.addEventListener('DOMContentLoaded', function() {
        initBossBattleHp();
      });
    })();
  </script>

  <!-- ã‚¯ã‚¤ã‚ºç”»é¢ç”¨BGMåˆ¶å¾¡ï¼ˆå¾…æ©Ÿç”»é¢ / ãƒãƒ£ãƒ¬ãƒ³ã‚¸é¸æŠã®ã¿ï¼‰ -->
  <script>
    (function () {
      const audio = document.getElementById("bgmAudio");
      const btn   = document.getElementById("bgmToggleBtn");
      if (!audio || !btn) return;  // playç”»é¢ãªã©ã€BGMãŒç„¡ã„ãƒ¢ãƒ¼ãƒ‰ã§ã¯ä½•ã‚‚ã—ãªã„

      // éŸ³é‡ã‚’50%ã«è¨­å®š
      audio.volume = 0.5;

      // quizå°‚ç”¨ã®ã‚­ãƒ¼ï¼ˆä»–ãƒšãƒ¼ã‚¸ã®BGMã¨ã¯ç‹¬ç«‹ï¼‰
      const STORAGE_KEY = "ifp_quiz_bgm_enabled";

      let enabled = localStorage.getItem(STORAGE_KEY);
      enabled = (enabled === null) ? true : (enabled === "true");

      const updateButtonText = () => {
        btn.textContent = enabled ? "ğŸµ BGM ON" : "ğŸ”‡ BGM OFF";
      };

      const playIfAllowed = async () => {
        if (!enabled) {
          try { audio.pause(); } catch(e) {}
          return;
        }
        try {
          await audio.play();
        } catch (e) {
          console.log("Quiz BGM autoplay blocked:", e);
        }
      };

      updateButtonText();

      // åˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§å†ç”Ÿé–‹å§‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿåˆ¶é™å¯¾ç­–ï¼‰
      const onFirstInteract = () => {
        document.removeEventListener("click", onFirstInteract);
        playIfAllowed();
      };
      document.addEventListener("click", onFirstInteract);

      // ãƒœã‚¿ãƒ³ON/OFF
      btn.addEventListener("click", async () => {
        enabled = !enabled;
        localStorage.setItem(STORAGE_KEY, String(enabled));
        updateButtonText();
        if (enabled) {
          await playIfAllowed();
        } else {
          audio.pause();
        }
      });
    })();
  </script>

  <script src="/static/quiz.js"></script>
</body>
</html>
